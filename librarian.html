<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard - BookScan&Find</title>
    <link rel="stylesheet" type="text/css" href="app.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="wrapper">
        <div id="navbar">
            <div class="logo">
                <h1>BookScan&Find</h1>
            </div>
            <ul>
                <li><a href="#" class="nav-link" data-target="Dashboard">Dashboard</a></li> <!-- Dashboard Link -->
                <li><a href="#" class="nav-link" data-target="addBook">Add Book</a></li> <!-- Add Book Link -->
                <li><a href="#" class="nav-link" data-target="addUser">Add User</a></li> <!-- Add User Link -->
                <li><a href="#" class="nav-link" data-target="displayBooks">Books Registered</a></li>
                <li><a href="#" class="nav-link" data-target="displayUsers">Users Registered</a></li>
                <li><a href="#" id="logout">Logout</a></li> <!-- Logout -->
            </ul>
        </div>
        <div id="main">
            <!-- Dashboard Section -->
            <div id="Dashboard" class="section">
                <h2>Dashboard</h2>
                <canvas id="dashboardChart" width="400" height="200"></canvas>
            </div>
            <!-- Add Book Section -->
        <div id="addBook" class="section">
            <h2>Add Book</h2>
            <input type="file" id="book_img" class="modern-input">
            <input type="text" id="book_title" placeholder="Book Title" class="modern-input">
            <input type="text" id="book_author" placeholder="Author" class="modern-input">
            <textarea id="book_description" placeholder="Description" class="modern-input"></textarea>
            <input type="text" id="book_category" placeholder="Category" class="modern-input">
            <input type="text" id="book_callnumber" placeholder="Call Number" class="modern-input">
            <input type="text" id="book_barcode" placeholder="Barcode" class="modern-input">
            <input type="number" id="book_shelfNumber" placeholder="Shelf Number" class="modern-input">
            <input type="number" id="book_shelfRow" placeholder="Shelf Row" class="modern-input">
            <input type="number" id="book_shelfColumn" placeholder="Shelf Column" class="modern-input">
            
            <!-- Book Status Dropdown -->
            <select id="book_status" class="modern-input">
                <option value="">Select Status</option>
                <option value="Available">Available</option>
                <option value="Unavailable">Unavailable</option>
                <option value="Disabled">Disabled</option>
            </select>
            
            <div style="text-align: center;">
                <label for="barcodeData" style="font-size: 1rem;">Enter Barcode Number:</label><br>
                <input type="text" id="barcodeData" placeholder="Barcode Number" class="modern-input" style="width: 50%; margin-bottom: 10px;">
                <br>
                <button id="generateBarcode" class="modern-button">Generate Barcode</button>
            </div>
            <div id="barcodeDisplay" style="text-align: center; margin-top: 20px; display: none;">
                <img id="barcodeImage" alt="Barcode" src="" style="margin-bottom: 10px;"/>
                <div>
                    <button id="downloadBarcode" class="modern-button" style="margin-top: 10px;">View Barcode</button>
                </div>
            </div>
            <button id="submitBook" class="modern-button">Add Book</button>
        </div> 
            <!-- Edit Book Section -->
            <div id="editBook" class="section">
                <h2>Edit Book</h2>
                <label for="edit_book_id">Book ID</label>
                <input type="text" id="edit_book_id" placeholder="Book ID" class="modern-input" readonly>
                <label for="edit_book_img">Book Image</label>
                <input type="file" id="edit_book_img" class="modern-input">
                <label for="edit_book_title">Book Title</label>
                <input type="text" id="edit_book_title" placeholder="Book Title" class="modern-input">
                <label for="edit_book_author">Author</label>
                <input type="text" id="edit_book_author" placeholder="Author" class="modern-input">
                <label for="edit_book_description">Description</label>
                <textarea id="edit_book_description" placeholder="Description" class="modern-input"></textarea>
                <label for="edit_book_category">Category</label>
                <input type="text" id="edit_book_category" placeholder="Category" class="modern-input">
                <label for="edit_book_callnumber">Call Number</label>
                <input type="text" id="edit_book_callnumber" placeholder="Call Number" class="modern-input">
                <label for="edit_book_barcode">Barcode</label>
                <input type="text" id="edit_book_barcode" placeholder="Barcode" class="modern-input">
                <label for="edit_book_shelfNumber">Shelf Number</label>
                <input type="number" id="edit_book_shelfNumber" placeholder="Shelf Number" class="modern-input">
                <label for="edit_book_shelfRow">Shelf Row</label>
                <input type="number" id="edit_book_shelfRow" placeholder="Shelf Row" class="modern-input">
                <label for="edit_book_shelfColumn">Shelf Column</label>
                <input type="number" id="edit_book_shelfColumn" placeholder="Shelf Column" class="modern-input">
                <button id="updateBook" class="modern-button">Update Book</button>
            </div>

            <!-- Add User Section -->
            <div id="addUser" class="section">
                <h2>Add User</h2>
                <input type="file" id="user_img" class="modern-input">
                 <!-- School Dropdown -->
                <select id="user_school_select" class="modern-input">
                    <option value="" disabled selected>Select School</option>
                </select>
                <input type="text" id="user_schoolid" placeholder="School ID" class="modern-input">
                <input type="text" id="user_lastname" placeholder="Last Name" class="modern-input">
                <input type="text" id="user_firstname" placeholder="First Name" class="modern-input">
                <input type="text" id="user_middleinitial" placeholder="Middle Initial (optional)" class="modern-input">
                <input type="text" id="user_contactnumber" placeholder="Contact Number" class="modern-input">
                
                <!-- Course Dropdown -->
                <select id="user_course" class="modern-input">
                    <option value="">Select Course</option>
                    <option value="Computer Science">Computer Science</option>
                    <option value="Engineering">Engineering</option>
                    <option value="Nursing">Nursing</option>
                    <option value="Health Aide">Health Aide</option>
                    <option value="Caregiver Course">Caregiver Course</option>
                    <option value="Information Technology">Information Technology</option>
                    <option value="Information Management">Information Management</option>
                    <option value="Computer Engineering">Computer Engineering</option>
                    <option value="Electronics and Communications Engineering">Electronics and Communications Engineering</option>
                    <option value="Elementary Education">Elementary Education</option>
                    <option value="Secondary Education">Secondary Education</option>
                    <option value="Criminology">Criminology</option>
                    <option value="Commerce">Commerce</option>
                    <option value="Accountancy">Accountancy</option>
                    <option value="Hotel and Restaurant Management">Hotel and Restaurant Management</option>
                    <option value="Tourism">Tourism</option>
                    <option value="Customs Administration">Customs Administration</option>
                    <option value="Computer Secretarial">Computer Secretarial</option>
                    <option value="Law">Law</option>
                    <!-- Add more course options as needed -->
                </select>

                <!-- Year Dropdown -->
                <select id="user_year" class="modern-input">
                    <option value="">Select Year</option>
                    <option value="1">1st Year</option>
                    <option value="2">2nd Year</option>
                    <option value="3">3rd Year</option>
                    <option value="4">4th Year</option>
                </select>
                
                <button id="submitUser" class="modern-button">Add User</button>
            </div>

            <!-- Edit User Section -->
            <div id="editUser" class="section">
                <h2>Edit User</h2>
                <input type="text" id="edit_user_id" placeholder="User ID" class="modern-input" readonly>
                <input type="file" id="edit_user_img" class="modern-input">
                <!-- School Dropdown -->
                <select id="edit_user_school_select" class="modern-input">
                    <option value="" disabled selected>Select School</option>
                </select>
                <input type="text" id="edit_user_schoolid" placeholder="School ID" class="modern-input">
                <input type="text" id="edit_user_lastname" placeholder="Last Name" class="modern-input">
                <input type="text" id="edit_user_firstname" placeholder="First Name" class="modern-input">
                <input type="text" id="edit_user_middleinitial" placeholder="Middle Initial (optional)" class="modern-input">
                <input type="password" id="edit_user_password" placeholder="Password" class="modern-input">
                <input type="text" id="edit_user_contactnumber" placeholder="Contact Number" class="modern-input">
                
                <!-- Course Dropdown -->
                <select id="edit_user_course" class="modern-input">
                    <option value="">Select Course</option>
                    <option value="Computer Science">Computer Science</option>
                    <option value="Engineering">Engineering</option>
                    <option value="Nursing">Nursing</option>
                    <option value="Health Aide">Health Aide</option>
                    <option value="Caregiver Course">Caregiver Course</option>
                    <option value="Information Technology">Information Technology</option>
                    <option value="Information Management">Information Management</option>
                    <option value="Computer Engineering">Computer Engineering</option>
                    <option value="Electronics and Communications Engineering">Electronics and Communications Engineering</option>
                    <option value="Elementary Education">Elementary Education</option>
                    <option value="Secondary Education">Secondary Education</option>
                    <option value="Criminology">Criminology</option>
                    <option value="Commerce">Commerce</option>
                    <option value="Accountancy">Accountancy</option>
                    <option value="Hotel and Restaurant Management">Hotel and Restaurant Management</option>
                    <option value="Tourism">Tourism</option>
                    <option value="Customs Administration">Customs Administration</option>
                    <option value="Computer Secretarial">Computer Secretarial</option>
                    <option value="Law">Law</option>
                    <!-- Add more course options as needed -->
                </select>

                <!-- Year Dropdown -->
                <select id="edit_user_year" class="modern-input">
                    <option value="">Select Year</option>
                    <option value="1">1st Year</option>
                    <option value="2">2nd Year</option>
                    <option value="3">3rd Year</option>
                    <option value="4">4th Year</option>
                </select>
                
                <button id="updateUser" class="modern-button">Update User</button>
            </div>


            <div id="displayBooks" class="section">
                <h2>Registered Books</h2>
                <div class="filters">
                    <input type="text" id="searchBookInput" placeholder="Search Books" class="modern-search-input">
                    <select id="bookCategoryFilter" class="modern-input">
                        <option value="">All Categories</option>
                        <option value="Fiction">Fiction</option>
                        <option value="Non-Fiction">Non-Fiction</option>
                        <option value="Science">Science</option>
                        <option value="History">History</option>
                        <option value="Horror">Horror</option>
                        <option value="Romance">Romance</option>
                        <option value="Computer Non-Fiction">Computer Non-Fiction</option>
                    </select>
                    <select id="bookStatusFilter" class="modern-input">
                        <option value="">All Statuses</option>
                        <option value="Available">Available</option>
                        <option value="Unavailable">Unavailable</option>
                        <option value="Disabled">Disabled</option>
                    </select>
                </div>
                <ul id="booksList"></ul>
            </div>
            
            <div id="displayUsers" class="section">
                <h2>Registered Users</h2>
                <div class="filters">
                    <input type="text" id="searchUserInput" placeholder="Search Users" class="modern-search-input">
                    <select id="userCourseFilter" class="modern-input">
                        <option value="">All Courses</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Nursing">Nursing</option>
                        <option value="Health Aide">Health Aide</option>
                        <option value="Caregiver Course">Caregiver Course</option>
                        <option value="Information Technology">Information Technology</option>
                        <option value="Information Management">Information Management</option>
                        <option value="Computer Engineering">Computer Engineering</option>
                        <option value="Electronics and Communications Engineering">Electronics and Communications Engineering</option>
                        <option value="Elementary Education">Elementary Education</option>
                        <option value="Secondary Education">Secondary Education</option>
                        <option value="Criminology">Criminology</option>
                        <option value="Commerce">Commerce</option>
                        <option value="Accountancy">Accountancy</option>
                        <option value="Hotel and Restaurant Management">Hotel and Restaurant Management</option>
                        <option value="Tourism">Tourism</option>
                        <option value="Customs Administration">Customs Administration</option>
                        <option value="Computer Secretarial">Computer Secretarial</option>
                        <option value="Law">Law</option>
                    </select>
                    <select id="userYearFilter" class="modern-input">
                        <option value="">All Years</option>
                        <option value="1">1st Year</option>
                        <option value="2">2nd Year</option>
                        <option value="3">3rd Year</option>
                        <option value="4">4th Year</option>
                    </select>
                </div>
                <ul id="usersList"></ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getDatabase, ref, get, push, child, set, update } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmTgqh5EXrrtRDJYSY6MvVE5gD7pwJfOE",
            authDomain: "bookscanandfind.firebaseapp.com",
            databaseURL: "https://bookscanandfind-default-rtdb.firebaseio.com",
            projectId: "bookscanandfind",
            storageBucket: "bookscanandfind.appspot.com",
            messagingSenderId: "214479740973",
            appId: "1:214479740973:web:cb437a5a4d9f22cdff18a4",
            measurementId: "G-MFXHQWH2Y3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        let currentEditingBookId = null;
        let currentEditingUserId = null;

        document.getElementById('logout').addEventListener('click', () => {
            signOut(auth).then(() => {
                sessionStorage.removeItem('loggedIn');
                // Ensure correct path
                window.location.href = './index.html';
            }).catch(error => {
                alert('Logout failed: ' + error.message);
            });
        });


       // Add Book
        document.getElementById('submitBook').addEventListener('click', () => {
            const submitButton = document.getElementById('submitBook');
            submitButton.disabled = true; // Disable the button

            const bookTitle = document.getElementById('book_title').value.trim();
            const bookAuthor = document.getElementById('book_author').value.trim();
            const bookDescription = document.getElementById('book_description').value.trim();
            const bookCategory = document.getElementById('book_category').value.trim();
            const bookCallNumber = document.getElementById('book_callnumber').value.trim();
            const bookBarcode = document.getElementById('book_barcode').value.trim();
            const bookShelfNumber = parseInt(document.getElementById('book_shelfNumber').value.trim(), 10);
            const bookShelfRow = parseInt(document.getElementById('book_shelfRow').value.trim(), 10);
            const bookShelfColumn = parseInt(document.getElementById('book_shelfColumn').value.trim(), 10);
            const bookStatus = document.getElementById('book_status').value.trim();
            const bookImg = document.getElementById('book_img').files[0];

            if (!bookTitle || !bookAuthor || !bookDescription || !bookCategory ||
                !bookCallNumber || !bookBarcode || isNaN(bookShelfNumber) || 
                isNaN(bookShelfRow) || isNaN(bookShelfColumn) || !bookStatus || !bookImg) {
                alert('Please fill out all fields and select an image.');
                submitButton.disabled = false; // Re-enable the button
                return;
            }

            if (!['Available', 'Unavailable', 'Disabled'].includes(bookStatus)) {
                alert('Please select a valid status.');
                submitButton.disabled = false; // Re-enable the button
                return;
            }

            const booksRef = ref(database, 'books/');
            get(booksRef)
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const books = snapshot.val();
                        const callNumberExists = Object.values(books).some(book => book.callnumber === bookCallNumber);
                        const barcodeExists = Object.values(books).some(book => book.barcode === bookBarcode);

                        if (callNumberExists) {
                            alert('A book with this Call Number already exists. Please use a different Call Number.');
                            submitButton.disabled = false; // Re-enable the button
                            return;
                        }

                        if (barcodeExists) {
                            alert('A book with this Barcode already exists. Please use a different Barcode.');
                            submitButton.disabled = false; // Re-enable the button
                            return;
                        }

                        const newBookRef = push(booksRef); // Generate a unique ID for the book
                        const bookId = newBookRef.key; // Retrieve the generated key

                        const storageReference = storageRef(storage, 'book_images/' + bookId);
                        uploadBytes(storageReference, bookImg)
                            .then(snapshot => getDownloadURL(snapshot.ref))
                            .then(url => set(newBookRef, {
                                id: bookId,
                                title: bookTitle,
                                author: bookAuthor,
                                description: bookDescription,
                                category: bookCategory,
                                callnumber: bookCallNumber,
                                barcode: bookBarcode,
                                shelfNumber: bookShelfNumber,
                                shelfRow: bookShelfRow,
                                shelfColumn: bookShelfColumn,
                                bookStatus: bookStatus,
                                imageURL: url
                            }))
                            .then(() => {
                                alert('Book added successfully.');
                                document.getElementById('book_title').value = '';
                                document.getElementById('book_author').value = '';
                                document.getElementById('book_description').value = '';
                                document.getElementById('book_category').value = '';
                                document.getElementById('book_callnumber').value = '';
                                document.getElementById('book_barcode').value = '';
                                document.getElementById('book_shelfNumber').value = '';
                                document.getElementById('book_shelfRow').value = '';
                                document.getElementById('book_shelfColumn').value = '';
                                document.getElementById('book_status').value = '';
                                document.getElementById('book_img').value = '';
                            })
                            .catch(error => alert('Failed to add book: ' + error.message))
                            .finally(() => submitButton.disabled = false); // Re-enable the button
                    } else {
                        alert('No existing books found in the database.');
                        submitButton.disabled = false; // Re-enable the button
                    }
                })
                .catch(error => {
                    alert('Error checking Call Number or Barcode: ' + error.message);
                    submitButton.disabled = false; // Re-enable the button
                });
        });


        document.getElementById('generateBarcode').addEventListener('click', () => {
            const barcodeData = document.getElementById('barcodeData').value.trim();

            if (!barcodeData) {
                alert('Please enter data to generate a barcode.');
                return;
            }

            // Generate the barcode image URL
            const barcodeImage = document.getElementById('barcodeImage');
            const barcodeUrl = `https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(barcodeData)}&code=Code128`;
            barcodeImage.src = barcodeUrl;

            // Show the barcode display
            document.getElementById('barcodeDisplay').style.display = 'block';

            // Set up the download functionality
            const downloadButton = document.getElementById('downloadBarcode');
            downloadButton.addEventListener('click', () => {
                const link = document.createElement('a');
                link.href = barcodeUrl; // Use the URL from the generated barcode
                link.download = `${barcodeData}_barcode.png`;
                link.click();
            });
        });
        function populateSchoolDropdowns() {
            const schoolSelectAdd = document.getElementById('user_school_select');
            const schoolSelectEdit = document.getElementById('edit_user_school_select');

            // Clear existing options
            schoolSelectAdd.innerHTML = '<option value="" disabled selected>Select School</option>';
            schoolSelectEdit.innerHTML = '<option value="" disabled selected>Select School</option>';

            // Fetch schools from Firebase
            get(child(ref(database), 'schools'))
                .then(snapshot => {
                    if (snapshot.exists()) {
                        console.log('Schools data fetched:', snapshot.val()); // Log data for debugging
                        snapshot.forEach(childSnapshot => {
                            const school = childSnapshot.val();

                            // Create an option element for the 'Add User' dropdown
                            const addOption = document.createElement('option');
                            addOption.value = school.name; // Use the school name as the value
                            addOption.textContent = school.name; // Display the school name
                            schoolSelectAdd.appendChild(addOption);

                            // Create a separate option element for the 'Edit User' dropdown
                            const editOption = document.createElement('option');
                            editOption.value = school.name;
                            editOption.textContent = school.name;
                            schoolSelectEdit.appendChild(editOption);
                        });
                    } else {
                        console.log('No schools found in the database.');
                        alert('No schools found in the database.');
                    }
                })
                .catch(error => {
                    console.error('Failed to fetch schools:', error);
                    alert('Unable to fetch schools. Please check the database or your connection.');
                });
    }

        // Call this function on page load
        window.addEventListener('load', populateSchoolDropdowns);
        
        // Add User
        document.getElementById('submitUser').addEventListener('click', () => {
            const submitButton = document.getElementById('submitUser');
            submitButton.disabled = true; // Disable the button

            const userSchoolId = document.getElementById('user_schoolid').value.trim();
            const userSchoolName = document.getElementById('user_school_select').value.trim(); // Added schoolname
            const userLastName = document.getElementById('user_lastname').value.trim();
            const userFirstName = document.getElementById('user_firstname').value.trim();
            const userMiddleInitial = document.getElementById('user_middleinitial').value.trim();
            const userContactNumber = document.getElementById('user_contactnumber').value.trim();
            const userCourse = document.getElementById('user_course').value.trim();
            const userYear = document.getElementById('user_year').value;
            const userImg = document.getElementById('user_img').files[0];

            if (
                userSchoolId &&
                userSchoolName && // Validate schoolname
                userLastName &&
                userFirstName &&
                userContactNumber &&
                userCourse &&
                userYear &&
                userImg
            ) {
                const otp = Math.floor(100000 + Math.random() * 900000).toString(); // Generate a 6-digit OTP as the password

                const usersRef = ref(database, 'users/');

                get(usersRef)
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const users = snapshot.val();
                            const schoolIdExists = Object.values(users).some(
                                (user) => user.schoolId === userSchoolId
                            );

                            if (schoolIdExists) {
                                alert(
                                    'A user with this School ID already exists. Please use a different School ID.'
                                );
                                submitButton.disabled = false; // Re-enable the button
                                return;
                            }
                        }

                        const newUserRef = push(usersRef); // Generate a unique ID
                        const userId = newUserRef.key; // Retrieve the generated key
                        const storageReference = storageRef(storage, 'user_images/' + userId);

                        uploadBytes(storageReference, userImg)
                            .then((snapshot) => getDownloadURL(snapshot.ref))
                            .then((url) =>
                                set(newUserRef, {
                                    userId: userId,
                                    schoolId: userSchoolId,
                                    schoolname: userSchoolName, // Save as schoolname
                                    lastName: userLastName,
                                    firstName: userFirstName,
                                    middleInitial: userMiddleInitial,
                                    password: otp, // Set the OTP as the password
                                    contactNumber: userContactNumber,
                                    course: userCourse,
                                    year: userYear,
                                    profileImageUrl: url,
                                })
                            )
                            .then(() => {
                                // Open SMS app to send OTP
                                const message = `This is your one-time password: ${otp}`;
                                window.location.href = `sms:${userContactNumber}?body=${encodeURIComponent(
                                    message
                                )}`;

                                alert('User added successfully and OTP has been sent!');
                                document.getElementById('user_schoolid').value = '';
                                document.getElementById('user_school_select').value = ''; // Clear schoolname
                                document.getElementById('user_lastname').value = '';
                                document.getElementById('user_firstname').value = '';
                                document.getElementById('user_middleinitial').value = '';
                                document.getElementById('user_contactnumber').value = '';
                                document.getElementById('user_course').value = '';
                                document.getElementById('user_year').value = '';
                                document.getElementById('user_img').value = '';
                            })
                            .catch((error) =>
                                alert('Failed to add user: ' + error.message)
                            )
                            .finally(() => (submitButton.disabled = false)); // Re-enable the button
                    })
                    .catch((error) => {
                        alert('Error checking School ID: ' + error.message);
                        submitButton.disabled = false; // Re-enable the button
                    });
            } else {
                alert('Please fill in all required fields.');
                submitButton.disabled = false; // Re-enable the button
            }
        });

        document.getElementById('updateBook').addEventListener('click', () => {
            const bookId = currentEditingBookId;
            if (!bookId) {
                console.error("Error: currentEditingBookId is not set.");
                alert("Error: Book ID is missing. Please try again.");
                return;
            }

            // Collect book data
            const bookData = {
                title: document.getElementById('edit_book_title').value.trim(),
                author: document.getElementById('edit_book_author').value.trim(),
                description: document.getElementById('edit_book_description').value.trim(),
                category: document.getElementById('edit_book_category').value.trim(),
                callnumber: document.getElementById('edit_book_callnumber').value.trim(),
                barcode: document.getElementById('edit_book_barcode').value.trim(),
                shelfNumber: parseInt(document.getElementById('edit_book_shelfNumber').value, 10),
                shelfRow: parseInt(document.getElementById('edit_book_shelfRow').value, 10),
                shelfColumn: parseInt(document.getElementById('edit_book_shelfColumn').value, 10)
            };

            // Check if shelf values are valid numbers
            if (isNaN(bookData.shelfNumber) || isNaN(bookData.shelfRow) || isNaN(bookData.shelfColumn)) {
                alert("Please enter valid numbers for the shelf fields.");
                return;
            }

            // Get the optional image file
            const bookImg = document.getElementById('edit_book_img').files[0]; // Optional image

            // If there's an image, upload it first
            if (bookImg) {
                const storageReference = storageRef(storage, 'book_images/' + bookId);

                // Upload the image and get the download URL
                uploadBytes(storageReference, bookImg)
                    .then(snapshot => getDownloadURL(snapshot.ref))
                    .then(url => {
                        // Update the bookData object with the image URL
                        bookData.imageURL = url;

                        // Update all fields in Firebase
                        return update(ref(database, 'books/' + bookId), bookData);
                    })
                    .then(() => {
                        alert('Book updated successfully with image.');
                        console.log("Firebase update successful:", bookData);
                        window.location.href = `bookDetails.html?id=${bookId}`;
                    })
                    .catch(error => {
                        console.error("Failed to update book with image:", error.message);
                        alert('Failed to update book: ' + error.message);
                    });
            } else {
                // If no image is provided, just update the book fields
                update(ref(database, 'books/' + bookId), bookData)
                    .then(() => {
                        alert('Book updated successfully.');
                        console.log("Firebase update successful:", bookData);
                        window.location.href = `bookDetails.html?id=${bookId}`;
                    })
                    .catch(error => {
                        console.error("Failed to update book:", error.message);
                        alert('Failed to update book: ' + error.message);
                    });
            }
        });


        document.getElementById('updateUser').addEventListener('click', () => {
            const userId = currentEditingUserId; // Ensure userId is set correctly
            const userSchoolId = document.getElementById('edit_user_schoolid').value.trim();
            const schoolName = document.getElementById('edit_user_school_select').value; // Get selected school name
            const userLastName = document.getElementById('edit_user_lastname').value.trim();
            const userFirstName = document.getElementById('edit_user_firstname').value.trim();
            const userPassword = document.getElementById('edit_user_password').value;
            const userContactNumber = document.getElementById('edit_user_contactnumber').value.trim();
            const userCourse = document.getElementById('edit_user_course').value.trim();
            const userYear = document.getElementById('edit_user_year').value; // Get year selection
            const userMiddleInitial = document.getElementById('edit_user_middleinitial').value.trim();
            const userImg = document.getElementById('edit_user_img').files[0]; // Optional image

            // Prepare userData object with only non-empty fields
            const userData = {
                schoolId: userSchoolId || null,
                schoolname: schoolName || null, // Ensure the selected school value is saved
                lastName: userLastName || null,
                firstName: userFirstName || null,
                password: userPassword || null,
                contactNumber: userContactNumber || null,
                course: userCourse || null,
                year: userYear || null
            };

            // Include middleInitial only if provided
            if (userMiddleInitial) {
                userData.middleInitial = userMiddleInitial;
            }

            // If there's an image, upload and update profileImageUrl
            if (userImg) {
                const storageReference = storageRef(storage, 'profile_images/' + userId);

                // Upload the image to storage and get the download URL
                uploadBytes(storageReference, userImg)
                    .then(snapshot => getDownloadURL(snapshot.ref))
                    .then(url => {
                        // Update only the profileImageUrl field
                        userData.profileImageUrl = url;

                        // Update all fields in Firebase
                        return update(ref(database, 'users/' + userId), userData);
                    })
                    .then(() => {
                        alert('User updated successfully');
                        navigateToSection('displayUsers');
                    })
                    .catch(error => alert('Failed to update user: ' + error.message));
            } else {
                // If no image, update Firebase directly without changing profileImageUrl
                update(ref(database, 'users/' + userId), userData)
                    .then(() => {
                        alert('User updated successfully');
                        navigateToSection('displayUsers');
                    })
                    .catch(error => alert('Failed to update user: ' + error.message));
            }
        });


        // Display Books (without settings menu)
        function displayBooks() {
            const searchQuery = document.getElementById('searchBookInput').value.toLowerCase();
            const categoryFilter = document.getElementById('bookCategoryFilter').value;
            const statusFilter = document.getElementById('bookStatusFilter').value;
            const booksList = document.getElementById('booksList');
            booksList.innerHTML = '';

            get(child(ref(database), 'books')).then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const book = childSnapshot.val();
                        const bookId = childSnapshot.key;

                        const matchesSearch = book.title.toLowerCase().includes(searchQuery) || 
                                              book.author.toLowerCase().includes(searchQuery);
                        const matchesCategory = !categoryFilter || book.category === categoryFilter;
                        const matchesStatus = !statusFilter || book.bookStatus === statusFilter;

                        if (matchesSearch && matchesCategory && matchesStatus) {
                            const listItem = document.createElement('li');
                            listItem.className = 'book-item';
                            listItem.dataset.id = bookId;
                            listItem.innerHTML = `
                                <img src="${book.imageURL}" alt="Book Image">
                                <div class="details">${book.title} <br> ${book.author}</div>
                            `;
                            booksList.appendChild(listItem);

                            listItem.querySelector('img').addEventListener('click', () => {
                                window.location.href = `bookDetails.html?id=${bookId}`;
                            });
                        }
                    });
                } else {
                    booksList.innerHTML = '<li>No books registered</li>';
                }
            }).catch(error => alert('Failed to retrieve books: ' + error.message));
        }

        // Display Users (without settings menu)
        function displayUsers() {
    const loggedInSchool = sessionStorage.getItem('librarianSchool'); // Retrieve the logged-in librarian's school

    if (!loggedInSchool) {
        alert('No school information found for the logged-in librarian.');
        return;
    }

    const searchQuery = document.getElementById('searchUserInput').value.toLowerCase();
    const courseFilter = document.getElementById('userCourseFilter').value;
    const yearFilter = document.getElementById('userYearFilter').value;
    const usersList = document.getElementById('usersList');
    usersList.innerHTML = '';

    get(child(ref(database), 'users')).then(snapshot => {
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                const user = childSnapshot.val();
                const userId = childSnapshot.key;

                // Filter users by school
                if (user.schoolname !== loggedInSchool) {
                    return; // Skip users not from the same school
                }

                const matchesSearch = `${user.firstName} ${user.lastName}`.toLowerCase().includes(searchQuery);
                const matchesCourse = !courseFilter || user.course === courseFilter;
                const matchesYear = !yearFilter || user.year === yearFilter;

                if (matchesSearch && matchesCourse && matchesYear) {
                    const listItem = document.createElement('li');
                    listItem.className = 'user-item';
                    listItem.dataset.id = userId;
                    listItem.innerHTML = `
                        <a href="userDetails.html?id=${userId}">
                            <img src="${user.profileImageUrl}" alt="User Image">
                            <div class="details">${user.firstName} ${user.lastName}<br>${user.course}, Year ${user.year}</div>
                        </a>
                    `;
                    usersList.appendChild(listItem);
                }
            });
        } else {
            usersList.innerHTML = '<li>No users registered</li>';
        }
    }).catch(error => alert('Failed to retrieve users: ' + error.message));
}

function setLibrarianSchool() {
    const loggedInLibrarianId = sessionStorage.getItem('loggedInLibrarianId'); // Assumes librarian ID is stored in sessionStorage

    if (!loggedInLibrarianId) {
        alert('No logged-in librarian found.');
        return;
    }

    const librarianRef = ref(database, `librarians/${loggedInLibrarianId}`);

    get(librarianRef)
        .then(snapshot => {
            if (snapshot.exists()) {
                const librarianData = snapshot.val();
                const schoolName = librarianData.schoolName;

                if (schoolName) {
                    sessionStorage.setItem('librarianSchool', schoolName); // Store the school name in sessionStorage
                    console.log('Librarian school set to:', schoolName);
                } else {
                    alert('No school information found for the logged-in librarian.');
                }
            } else {
                alert('Librarian data not found.');
            }
        })
        .catch(error => {
            alert('Failed to retrieve librarian data: ' + error.message);
        });
}

// Call this function during login or page load
setLibrarianSchool();

        // Event listeners for filters and search
        document.getElementById('userCourseFilter').addEventListener('change', displayUsers);
        document.getElementById('userYearFilter').addEventListener('change', displayUsers);
        // document.getElementById('searchUserInput').addEventListener('input', displayUsers);

        // Event listeners for filters and search
        document.getElementById('bookCategoryFilter').addEventListener('change', displayBooks);
        document.getElementById('bookStatusFilter').addEventListener('change', displayBooks);
        document.getElementById('searchBookInput').addEventListener('input', displayBooks);
        document.getElementById('searchBookInput').removeEventListener('input', displayBooks);

        let dashboardChart; // Global variable to hold the chart instance

        // Update Dashboard Chart
        function updateDashboardChart() {
            const labels = ['Books', 'Users'];
            const data = [0, 0]; // Array to store book and user counts

            // Retrieve number of books
            get(child(ref(database), 'books')).then(snapshot => {
                if (snapshot.exists()) {
                    data[0] = snapshot.size; // Number of books
                }

                // Retrieve number of users
                return get(child(ref(database), 'users'));
            }).then(snapshot => {
                if (snapshot.exists()) {
                    data[1] = snapshot.size; // Number of users
                }

                // If a chart instance already exists, destroy it
                if (dashboardChart) {
                    dashboardChart.destroy();
                }

                // Render the new chart
                const ctx = document.getElementById('dashboardChart').getContext('2d');
                dashboardChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Counts',
                            data: data,
                            backgroundColor: ['rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)'],
                            borderColor: ['rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                ticks: {
                                    color: '#000', // Set x-axis tick labels to black
                                    font: {
                                        size: 14,
                                        family: 'Arial',
                                        weight: 'bold'
                                    }
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#000', // Set y-axis tick labels to black
                                    font: {
                                        size: 14,
                                        family: 'Arial',
                                        weight: 'bold'
                                    }
                                },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#000', // Set legend text color to black
                                    font: {
                                        size: 14,
                                        family: 'Arial',
                                        weight: 'bold'
                                    }
                                }
                            },
                            tooltip: {
                                bodyColor: '#fff', // Tooltip body text color
                                titleColor: '#fff', // Tooltip title text color
                                footerColor: '#fff' // Tooltip footer text color
                            }
                        }
                    }
                });
            }).catch(error => alert('Failed to update chart: ' + error.message));
        }
        
        function loadEditingBookData() {
            const bookData = JSON.parse(sessionStorage.getItem("editingBookData"));
            if (bookData) {
                currentEditingBookId = bookData.id; // Set the global editing book ID
                console.log("Loading book for editing with ID:", bookData.id);

                // Populate the form with existing book data
                document.getElementById('edit_book_id').value = bookData.id;
                document.getElementById('edit_book_title').value = bookData.title;
                document.getElementById('edit_book_author').value = bookData.author;
                document.getElementById('edit_book_description').value = bookData.description;
                document.getElementById('edit_book_category').value = bookData.category;
                document.getElementById('edit_book_callnumber').value = bookData.callnumber;
                document.getElementById('edit_book_barcode').value = bookData.barcode;
                document.getElementById('edit_book_shelfNumber').value = bookData.shelfNumber;
                document.getElementById('edit_book_shelfRow').value = bookData.shelfRow;
                document.getElementById('edit_book_shelfColumn').value = bookData.shelfColumn;
            } else {
                alert("No book data found for editing.");
                console.error("Error: No book data found in sessionStorage.");
            }
        }

        function prepareUserForEditing(user) {
            // Create an object with user data and include uid
            const userData = {
                userId: user.uid, // uid as identifier
                schoolId: user.schoolId,
                lastName: user.lastName,
                firstName: user.firstName,
                middleInitial: user.middleInitial,
                password: user.password,
                contactNumber: user.contactNumber,
                course: user.course,
                year: user.year
            };

            // Save the userData (including uid as userId) to sessionStorage
            sessionStorage.setItem("editingUserData", JSON.stringify(userData));

            // Navigate to the edit user section
            navigateToSection('editUser');
        }


        function loadEditingUserData() {
            const userData = JSON.parse(sessionStorage.getItem("editingUserData"));
            if (userData) {
                currentEditingUserId = userData.userId; // Set the global editing user ID
                console.log("Loading user for editing with ID:", userData.userId);

                // Populate the form with existing user data
                document.getElementById('edit_user_id').value = userData.userId;
                document.getElementById('edit_user_schoolid').value = userData.schoolId;
                document.getElementById('edit_user_lastname').value = userData.lastName;
                document.getElementById('edit_user_firstname').value = userData.firstName;
                document.getElementById('edit_user_middleinitial').value = userData.middleInitial || "";
                document.getElementById('edit_user_password').value = userData.password;
                document.getElementById('edit_user_contactnumber').value = userData.contactNumber;
                document.getElementById('edit_user_course').value = userData.course;
                document.getElementById('edit_user_year').value = userData.year;
            } else {
                alert("No user data found for editing.");
                console.error("Error: No user data found in sessionStorage.");
            }
        }

        // Navigation
        function navigateToSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';

            // Load chart data only if navigating to the Dashboard
            if (sectionId === 'Dashboard') {
                updateDashboardChart(); // Ensure chart is loaded when clicking on the Dashboard
            }

            if (sectionId === 'editBook') {
            loadEditingBookData();
            }
            else if (sectionId === 'editUser') {
                loadEditingUserData();
            }

            history.pushState(null, '', `#${sectionId}`);
        }

        window.addEventListener('popstate', () => {
            const sectionId = location.hash.substring(1) || 'Dashboard';
            navigateToSection(sectionId);
        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', event => {
                event.preventDefault();
                const targetId = event.target.getAttribute('data-target');
                navigateToSection(targetId);

                if (targetId === 'displayBooks') displayBooks();
                else if (targetId === 'displayUsers') displayUsers();
                else if (targetId === 'createBarcode') {
                    document.getElementById('barcodeDisplay').style.display = 'none'; // Reset the barcode display
                }
            });
        });

        function checkAuthentication() {
            if (!sessionStorage.getItem('loggedIn')) {
                // If not logged in, redirect to the SignIn.html page
                window.location.href = 'index.html';
            }
        }

        // Event listeners for dynamic search
        document.getElementById('searchBookInput').addEventListener('input', displayBooks);
        document.getElementById('searchUserInput').addEventListener('input', displayUsers);

        // Load Data on Page Load
        window.addEventListener('load', () => {
            checkAuthentication();
            const sectionId = location.hash.substring(1) || 'Dashboard';
            navigateToSection(sectionId);
            updateDashboardChart();
            displayBooks();
            displayUsers();
        });
    </script>
</body>
</html>
