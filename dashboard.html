<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard - BookScan&Find</title>
    <link rel="stylesheet" type="text/css" href="app.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="wrapper">
        <div id="navbar">
            <div class="logo">
                <h1>BookScan&Find</h1>
            </div>
            <ul>
                <li><a href="#" class="nav-link" data-target="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link" data-target="addSchool">Add School</a></li>
                <li><a href="#" class="nav-link" data-target="addLibrarian">Add Librarian</a></li>
                <li><a href="#" class="nav-link" data-target="displaySchools">Schools Registered</a></li>
                <li><a href="#" class="nav-link" data-target="displayLibrarians">Librarians Registered</a></li>
                <li><a href="#" class="nav-link" data-target="displayUsers">Users Registered</a></li>
                <li><a href="#" id="logout">Logout</a></li> <!-- Logout -->
            </ul>
        </div>
        <div id="main">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <h2>Dashboard</h2>
                <canvas id="dashboardChart" width="400" height="200"></canvas>
            </div>

            <!-- Add School Section -->
            <div id="addSchool" class="section">
                <h2>Add School</h2>
                <input type="file" id="school_img" class="modern-input">
                <input type="text" id="school_name" placeholder="School Name" class="modern-input">
                <input type="text" id="school_location" placeholder="School Location" class="modern-input">
                <input type="text" id="school_contactnum" placeholder="School Contact Number" class="modern-input">
                <button id="submitSchool" class="modern-button">Add School</button>
            </div>

            <!-- Add Librarian Section -->
            <div id="addLibrarian" class="section">
                <h2>Add Librarian</h2>

                <input type="text" id="lib_id" placeholder="Unique ID (Manual Input)" class="modern-input">
                <!-- Dropdown for selecting school -->
                <select id="lib_school_select" class="modern-input">
                    <option value="" disabled selected>Select School</option>
                </select>
                <input type="text" id="lib_school_id" placeholder="Enter School ID" class="modern-input">
                <input type="file" id="lib_img" class="modern-input">
                <input type="text" id="lib_lastname" placeholder="Librarian Last Name" class="modern-input">
                <input type="text" id="lib_firstname" placeholder="Librarian First Name" class="modern-input">
                <input type="text" id="lib_middleinitial" placeholder="Librarian Middle Initial (optional)" class="modern-input">
                <input type="password" id="lib_password" placeholder="Password" class="modern-input">
                <input type="text" id="lib_contactnum" placeholder="Librarian Contact Number" class="modern-input">
                <input type="text" id="lib_role" placeholder="Librarian Role" class="modern-input">
                <input type="email" id="lib_email" placeholder="Librarian Email" class="modern-input">
                <button id="submitLibrarian" class="modern-button">Add Librarian</button>
            </div>

            <!-- Display Schools Section -->
            <div id="displaySchools" class="section">
                <h2>Registered Schools</h2>
                <input type="text" id="searchSchoolInput" placeholder="Search Schools" class="modern-search-input">
                <ul id="schoolsList"></ul>
            </div>

            <!-- Display Librarians Section -->
            <div id="displayLibrarians" class="section">
                <h2>Registered Librarians</h2>
                <input type="text" id="searchLibrarianInput" placeholder="Search Librarians" class="modern-search-input">
                <!-- School Filter Dropdown -->
            <select id="librarianSchoolFilter" class="modern-input">
                <option value="">All Schools</option>
            </select>
            <!-- Role Filter Dropdown -->
            <select id="librarianRoleFilter" class="modern-input">
                <option value="">All Roles</option>
                <option value="Head Librarian">Head Librarian</option>
                <option value="Assistant Librarian">Assistant Librarian</option>
                <option value="Library Staff">Library Staff</option>
            </select>
                    <ul id="librariansList"></ul>
            </div>

            <!-- Display Users Section -->
            <div id="displayUsers" class="section">
                <h2>Registered Users</h2>
                <input type="text" id="searchUserInput" placeholder="Search Users" class="modern-search-input">
                <select id="userCourseFilter" class="modern-input">
                    <option value="">All Courses</option>
                </select>
                <select id="userYearFilter" class="modern-input">
                    <option value="">All Years</option>
                </select>
                <select id="userSchoolFilter" class="modern-input">
                    <option value="">All Schools</option>
                </select>
                <ul id="usersList"></ul>
            </div>

            <!-- Edit School Section -->
            <div id="editSchool" class="section">
                <h2>Edit School</h2>
                <input type="file" id="edit_school_img" class="modern-input">
                <input type="text" id="edit_school_name" placeholder="School Name" class="modern-input">
                <input type="text" id="edit_school_location" placeholder="School Location" class="modern-input">
                <input type="text" id="edit_school_contactnum" placeholder="School Contact Number" class="modern-input">
                <button id="updateSchool" class="modern-button">Update School</button>
            </div>

            <div id="editLibrarian" class="section">
                <h2>Edit Librarian</h2>
                <input type="text" id="edit_lib_id" placeholder="Unique ID" class="modern-input" readonly>
                
                <!-- Text input for School ID -->
                <input type="text" id="edit_lib_schoolid" placeholder="School ID" class="modern-input">
            
                <!-- Dropdown for selecting the school name -->
                <select id="edit_lib_school_select" class="modern-input">
                    <option value="" disabled selected>Select School</option>
                </select>
                
                <input type="file" id="edit_lib_img" class="modern-input">
                <input type="text" id="edit_lib_lastname" placeholder="Librarian Last Name" class="modern-input">
                <input type="text" id="edit_lib_firstname" placeholder="Librarian First Name" class="modern-input">
                <input type="text" id="edit_lib_middleinitial" placeholder="Librarian Middle Initial (optional)" class="modern-input">
                <input type="password" id="edit_lib_password" placeholder="Password" class="modern-input">
                <input type="text" id="edit_lib_contactnum" placeholder="Librarian Contact Number" class="modern-input">
                <input type="text" id="edit_lib_role" placeholder="Librarian Role" class="modern-input">
                <input type="email" id="edit_lib_email" placeholder="Librarian Email" class="modern-input">
            
                <!-- Dropdown for changing status -->
                <select id="edit_lib_status" class="modern-input">
                    <option value="" disabled selected>Select Status</option>
                    <option value="Enabled">Enabled</option>
                    <option value="Disabled">Disabled</option>
                </select>
                
                <button id="updateLibrarian" class="modern-button">Update Librarian</button>
            </div>
            
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getDatabase, ref, set, get, child, push, update } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
        import { getAuth, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmTgqh5EXrrtRDJYSY6MvVE5gD7pwJfOE",
            authDomain: "bookscanandfind.firebaseapp.com",
            databaseURL: "https://bookscanandfind-default-rtdb.firebaseio.com",
            projectId: "bookscanandfind",
            storageBucket: "bookscanandfind.appspot.com",
            messagingSenderId: "214479740973",
            appId: "1:214479740973:web:cb437a5a4d9f22cdff18a4",
            measurementId: "G-MFXHQWH2Y3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        
        function checkAuthentication() {
            if (!sessionStorage.getItem('loggedIn')) {
                window.location.replace('index.html');
            }
        }

        document.getElementById('logout').addEventListener('click', () => {
            signOut(auth).then(() => {
                // Clear session and redirect to sign-in page
                sessionStorage.removeItem('loggedIn');
                window.location.href = 'index.html'; // Redirect to the renamed file
            }).catch(error => {
                alert('Logout failed: ' + error.message);
            });
        });

        function populateSchoolDropdown() {
        const schoolSelect = document.getElementById('lib_school_select');

        // Reset the dropdown options
        schoolSelect.innerHTML = '<option value="" disabled selected>Select School</option>';

        // Fetch schools from the database
        get(child(ref(database), 'schools'))
            .then(snapshot => {
                if (snapshot.exists()) {
                    console.log("Schools fetched successfully:", snapshot.val()); // Debug log
                    snapshot.forEach(childSnapshot => {
                        const school = childSnapshot.val();
                        const option = document.createElement('option');
                        option.value = school.name; // Use school name as value
                        option.textContent = school.name; // Display school name
                        schoolSelect.appendChild(option);
                    });
                } else {
                    console.log('No schools found in the database.'); // Debug log
                    alert('No schools available to select.');
                }
            })
            .catch(error => {
                console.error('Error fetching schools:', error); // Debug log
                alert('Failed to fetch schools: ' + error.message);
            });
    }
        // Call this function on page load
        window.addEventListener('load', populateSchoolDropdown);

        // Add School
document.getElementById('submitSchool').addEventListener('click', () => {
    const schoolName = document.getElementById('school_name').value.trim();
    const schoolLocation = document.getElementById('school_location').value.trim();
    const schoolContactNum = document.getElementById('school_contactnum').value.trim();
    const schoolImg = document.getElementById('school_img').files[0];

    if (schoolName && schoolLocation && schoolContactNum && schoolImg) {
        // Reference to all schools in the database
        const schoolsRef = ref(database, 'schools/');

        // Check for duplicate school name
        get(schoolsRef)
            .then(snapshot => {
                if (snapshot.exists()) {
                    const schools = snapshot.val();
                    const schoolNameExists = Object.values(schools).some(school => school.name.toLowerCase() === schoolName.toLowerCase());

                    if (schoolNameExists) {
                        alert('A school with this name already exists. Please use a different name.');
                        return; // Stop further execution
                    }

                    // If no duplicate name, proceed to add the school
                    const schoolId = push(ref(database, 'schools')).key;
                    const storageReference = storageRef(storage, 'school_images/' + schoolId);

                    uploadBytes(storageReference, schoolImg)
                        .then(snapshot => getDownloadURL(snapshot.ref))
                        .then(url => set(ref(database, 'schools/' + schoolId), {
                            name: schoolName,
                            location: schoolLocation,
                            contactNum: schoolContactNum,
                            imageUrl: url
                        }))
                        .then(() => {
                            alert('School added successfully');
                            displaySchools();
                            document.getElementById('school_img').value = '';
                            document.getElementById('school_name').value = '';
                            document.getElementById('school_location').value = '';
                            document.getElementById('school_contactnum').value = '';
                        })
                        .catch(error => alert('Failed to add school: ' + error.message));
                } else {
                    // Handle case where no schools exist in the database yet
                    const schoolId = push(ref(database, 'schools')).key;
                    const storageReference = storageRef(storage, 'school_images/' + schoolId);

                    uploadBytes(storageReference, schoolImg)
                        .then(snapshot => getDownloadURL(snapshot.ref))
                        .then(url => set(ref(database, 'schools/' + schoolId), {
                            name: schoolName,
                            location: schoolLocation,
                            contactNum: schoolContactNum,
                            imageUrl: url
                        }))
                        .then(() => {
                            alert('School added successfully');
                            displaySchools();
                            document.getElementById('school_img').value = '';
                            document.getElementById('school_name').value = '';
                            document.getElementById('school_location').value = '';
                            document.getElementById('school_contactnum').value = '';
                        })
                        .catch(error => alert('Failed to add school: ' + error.message));
                }
            })
            .catch(error => alert('Error checking school name: ' + error.message));
    } else {
        alert('All fields are required');
    }
});

        document.getElementById('submitLibrarian').addEventListener('click', () => {
            const libId = document.getElementById('lib_id').value.trim();
            const schoolId = document.getElementById('lib_school_id').value.trim(); // Inputted School ID
            const schoolName = document.getElementById('lib_school_select').value; // Selected School Name
            const libLastName = document.getElementById('lib_lastname').value.trim();
            const libFirstName = document.getElementById('lib_firstname').value.trim();
            const libMiddleInitial = document.getElementById('lib_middleinitial').value.trim();
            const libPassword = document.getElementById('lib_password').value.trim();
            const libContactNum = document.getElementById('lib_contactnum').value.trim();
            const libRole = document.getElementById('lib_role').value.trim();
            const libEmail = document.getElementById('lib_email').value.trim();
            const libImg = document.getElementById('lib_img').files[0];

            // Email validation regex
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            // Validate that all required fields are filled and email is valid
            if (
                libId &&
                schoolId &&
                schoolName &&
                libLastName &&
                libFirstName &&
                libPassword &&
                libContactNum &&
                libRole &&
                libEmail &&
                libImg
            ) {
                if (!emailRegex.test(libEmail)) {
                    alert('Please enter a valid email address.');
                    return;
                }

                // Reference to all librarians in the database
                const librariansRef = ref(database, 'librarians/');

                // Check if the schoolId or email already exists
                get(librariansRef)
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const librarians = snapshot.val();
                            const schoolIdExists = Object.values(librarians).some(librarian => librarian.schoolId === schoolId);
                            const emailExists = Object.values(librarians).some(librarian => librarian.email === libEmail);

                            if (schoolIdExists) {
                                // If the schoolId already exists, alert the user
                                alert('A librarian with this School ID already exists. Please use a different School ID.');
                                return; // Stop further execution
                            }

                            if (emailExists) {
                                // If the email already exists, alert the user
                                alert('A librarian with this email already exists. Please use a different email.');
                                return; // Stop further execution
                            }

                            // Reference to the specific librarian ID
                            const librarianRef = ref(database, 'librarians/' + libId);

                            // Check if the librarian ID already exists
                            get(librarianRef)
                                .then(snapshot => {
                                    if (snapshot.exists()) {
                                        alert('A librarian with this ID already exists. Please use a different ID.');
                                    } else {
                                        // Upload image to Firebase Storage
                                        const storageReference = storageRef(storage, 'librarian_images/' + libId);
                                        uploadBytes(storageReference, libImg)
                                            .then(snapshot => getDownloadURL(snapshot.ref))
                                            .then(url => {
                                                // Save librarian data to Firebase Realtime Database
                                                const librarianData = {
                                                    id: libId,
                                                    schoolId: schoolId, // Save the inputted School ID
                                                    schoolName: schoolName, // Save the selected School Name
                                                    lastName: libLastName,
                                                    firstName: libFirstName,
                                                    middleInitial: libMiddleInitial,
                                                    contactNum: libContactNum,
                                                    role: libRole,
                                                    email: libEmail,
                                                    password: libPassword,
                                                    imageUrl: url,
                                                };

                                                return set(librarianRef, librarianData);
                                            })
                                            .then(() => {
                                                alert('Librarian added successfully!');
                                                // Reset form fields after success
                                                document.getElementById('lib_id').value = '';
                                                document.getElementById('lib_school_id').value = '';
                                                document.getElementById('lib_school_select').value = '';
                                                document.getElementById('lib_lastname').value = '';
                                                document.getElementById('lib_firstname').value = '';
                                                document.getElementById('lib_middleinitial').value = '';
                                                document.getElementById('lib_password').value = '';
                                                document.getElementById('lib_contactnum').value = '';
                                                document.getElementById('lib_role').value = '';
                                                document.getElementById('lib_email').value = '';
                                                document.getElementById('lib_img').value = '';
                                            })
                                            .catch(error => alert('Error adding librarian: ' + error.message));
                                    }
                                })
                                .catch(error => alert('Error checking librarian ID: ' + error.message));
                        } else {
                            // Handle case where no librarians exist in the database yet
                            alert('No existing librarians found in the database.');
                        }
                    })
                    .catch(error => alert('Error checking School ID or Email: ' + error.message));
            } else {
                alert('Please fill out all fields.');
            }
        });


        // Update Dashboard Chart
        function updateDashboardChart() {
            const labels = ['Schools', 'Librarians', 'users'];
            const data = [0, 0, 0];

            get(child(ref(database), 'schools')).then(snapshot => {
                data[0] = snapshot.exists() ? snapshot.size : 0;
                return get(child(ref(database), 'librarians'));
            }).then(snapshot => {
                data[1] = snapshot.exists() ? snapshot.size : 0;
                return get(child(ref(database), 'users'));
            }).then(snapshot => {
                data[2] = snapshot.exists() ? snapshot.size : 0;

                new Chart(document.getElementById('dashboardChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Schools', 'Librarians', 'Users'],
                        datasets: [{
                            label: 'Counts',
                            data: data,
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                                'rgba(255, 159, 64, 0.8)'
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                ticks: {
                                    color: '#000', // Set x-axis tick labels to black
                                    font: {
                                        size: 14,
                                        family: 'Arial',
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#000', // Set y-axis tick labels to black
                                    font: {
                                        size: 14,
                                        family: 'Arial',
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#000', // Set legend text color to black
                                    font: {
                                        size: 14,
                                        family: 'Arial',
                                        weight: 'bold'
                                    }
                                }
                            },
                            tooltip: {
                                bodyColor: '#fff', // Tooltip body text color
                                titleColor: '#fff', // Tooltip title text color
                                footerColor: '#fff' // Tooltip footer text color
                            }
                        }
                    }
                });
            }).catch(error => alert('Failed to update chart: ' + error.message));
        }

        // Event listeners for search inputs
        document.getElementById('searchSchoolInput').addEventListener('input', displaySchools);
        document.getElementById('searchLibrarianInput').addEventListener('input', displayLibrarians);
        document.getElementById('searchUserInput').addEventListener('input', displayUsers);

        let currentEditingSchoolId = null;
        let currentEditingLibrarianId = null;
        let currentEditingUserId = null;

        // Display Schools
        function displaySchools() {
            const searchQuery = document.getElementById('searchSchoolInput').value.toLowerCase();
            const schoolsList = document.getElementById('schoolsList');
            schoolsList.innerHTML = '';

            get(child(ref(database), 'schools')).then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const school = childSnapshot.val();
                        const schoolId = childSnapshot.key;
                        if (school.name.toLowerCase().includes(searchQuery) ||
                            school.location.toLowerCase().includes(searchQuery) ||
                            school.contactNum.includes(searchQuery)) {
                            const listItem = document.createElement('li');
                            listItem.className = 'school-item';
                            listItem.dataset.id = schoolId;
                            listItem.innerHTML = `
                                <img src="${school.imageUrl}" alt="School Image">
                                <div class="details">${school.name}<br>${school.location}<br>${school.contactNum}</div>`;
                            
                            // Add click event listener for navigation
                            listItem.addEventListener('click', () => {
                                window.location.href = `schoolDetails.html?id=${schoolId}`;
                            });

                            schoolsList.appendChild(listItem);
                        }
                    });
                } else {
                    schoolsList.innerHTML = '<li>No schools registered</li>';
                }
            }).catch(error => alert('Failed to retrieve schools: ' + error.message));
        }

        // Populate School Dropdown for Filtering
        function populateLibrarianSchoolFilter() {
            const schoolFilterDropdown = document.getElementById('librarianSchoolFilter');

            // Reset dropdown options
            schoolFilterDropdown.innerHTML = '<option value="">All Schools</option>';

            // Fetch schools from Firebase
            get(child(ref(database), 'schools'))
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const schools = snapshot.val();
                        console.log('Schools data fetched:', schools); // Debug log

                        // Populate dropdown with school names
                        Object.keys(schools).forEach(schoolId => {
                            const school = schools[schoolId];
                            const option = document.createElement('option');
                            option.value = school.name; // Use school name as the value
                            option.textContent = school.name; // Display school name
                            schoolFilterDropdown.appendChild(option);
                        });
                    } else {
                        console.warn('No schools found in the database.');
                    }
                })
                .catch(error => {
                    console.error('Failed to fetch schools:', error.message);
                });
        }

        // Call this function on page load
        window.addEventListener('load', () => {
            populateLibrarianSchoolFilter();
            // displayLibrarians();
        });


        // Display Librarians
        // Filter and Display Librarians
        function displayLibrarians() {
            const searchQuery = document.getElementById('searchLibrarianInput').value.toLowerCase();
            const selectedSchool = document.getElementById('librarianSchoolFilter').value;
            const selectedRole = document.getElementById('librarianRoleFilter').value;
            const librariansList = document.getElementById('librariansList');
            librariansList.innerHTML = ''; // Clear the list before populating

            // Fetch librarians from Firebase
            get(child(ref(database), 'librarians'))
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const addedLibrarianIds = new Set(); // Track displayed librarians
                        snapshot.forEach(childSnapshot => {
                            const librarian = childSnapshot.val();
                            const librarianId = childSnapshot.key;

                            // Check filters
                            const matchesSearch =
                                `${librarian.firstName || ''} ${librarian.lastName || ''}`.toLowerCase().includes(searchQuery);
                            const matchesSchool = !selectedSchool || librarian.schoolName === selectedSchool;
                            const matchesRole = !selectedRole || librarian.role === selectedRole;

                            if (matchesSearch && matchesSchool && matchesRole && !addedLibrarianIds.has(librarianId)) {
                                const listItem = document.createElement('li');
                                listItem.className = 'librarian-item';
                                listItem.dataset.id = librarianId;
                                listItem.innerHTML = `
                                    <img src="${librarian.imageUrl || 'default-placeholder.png'}" alt="Librarian Image">
                                    <div class="details">
                                        <strong>${librarian.schoolName || 'No School Assigned'}</strong><br>
                                        ${librarian.firstName || ''} ${librarian.middleInitial || ''} ${librarian.lastName || ''}<br>
                                        ${librarian.role || 'No Role Assigned'}
                                    </div>
                                `;
                                librariansList.appendChild(listItem);

                                // Add navigation to details page
                                listItem.addEventListener('click', () => {
                                    window.location.href = `librarianDetails.html?id=${librarianId}`;
                                });

                                addedLibrarianIds.add(librarianId); // Mark this librarian as added
                            }
                        });

                        if (addedLibrarianIds.size === 0) {
                            librariansList.innerHTML = '<li>No librarians found.</li>';
                        }
                    } else {
                        librariansList.innerHTML = '<li>No librarians registered.</li>';
                    }
                })
                .catch(error => console.error('Failed to fetch librarians:', error.message));
        }

        function editPopulateSchoolDropdown() {
            const schoolSelect = document.getElementById('edit_lib_school_select');

            // Clear existing options
            schoolSelect.innerHTML = '<option value="" disabled selected>Select School</option>';

            // Fetch schools from Firebase
            get(child(ref(database), 'schools'))
                .then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const school = childSnapshot.val();
                            const option = document.createElement('option');
                            option.value = school.name; // Use school name as value
                            option.textContent = school.name; // Display school name
                            schoolSelect.appendChild(option);
                        });
                        console.log("Schools dropdown populated successfully.");
                    } else {
                        alert('No schools available to select.');
                    }
                })
                .catch(error => {
                    console.error("Error fetching schools:", error);
                    alert('Failed to fetch schools: ' + error.message);
                });
        }

        // Load librarian data for editing
        function loadEditingLibrarianData() {
            const librarianData = JSON.parse(sessionStorage.getItem("editingLibrarianData"));
            if (librarianData) {
                currentEditingLibrarianId = librarianData.id;
                document.getElementById('edit_lib_id').value = librarianData.id;
                document.getElementById('edit_lib_schoolid').value = librarianData.schoolId; // Set School ID
                document.getElementById('edit_lib_lastname').value = librarianData.lastName;
                document.getElementById('edit_lib_firstname').value = librarianData.firstName;
                document.getElementById('edit_lib_middleinitial').value = librarianData.middleInitial || "";
                document.getElementById('edit_lib_password').value = librarianData.password;
                document.getElementById('edit_lib_contactnum').value = librarianData.contactNum;
                document.getElementById('edit_lib_role').value = librarianData.role;
                document.getElementById('edit_lib_email').value = librarianData.email;
                document.getElementById('edit_lib_status').value = librarianData.accountStatus || "";

                // Pre-select school in the dropdown if available
                const schoolSelect = document.getElementById('edit_lib_school_select');
                if (librarianData.schoolName) {
                    Array.from(schoolSelect.options).forEach(option => {
                        if (option.value === librarianData.schoolName) {
                            option.selected = true;
                        }
                    });
                }
            } else {
                alert("Error: No data found for editing.");
            }
        }

        // Trigger loading data when navigating to the Edit Librarian section
        window.addEventListener("load", () => {
            if (location.hash === "#editLibrarian") {
                loadEditingLibrarianData();
            }
        });

        // Populate Dropdown Filters for Users
        function populateUserFilters() {
            const courseFilter = document.getElementById('userCourseFilter');
            const yearFilter = document.getElementById('userYearFilter');
            const schoolFilter = document.getElementById('userSchoolFilter');

            // Reset dropdowns
            courseFilter.innerHTML = '<option value="">All Courses</option>';
            yearFilter.innerHTML = '<option value="">All Years</option>';
            schoolFilter.innerHTML = '<option value="">All Schools</option>';

            // Fetch users from Firebase to extract filter options
            get(child(ref(database), 'users'))
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const courses = new Set();
                        const years = new Set();
                        const schools = new Set();

                        snapshot.forEach(childSnapshot => {
                            const user = childSnapshot.val();
                            if (user.course) courses.add(user.course);
                            if (user.year) years.add(user.year);
                            if (user.schoolname) schools.add(user.schoolname);
                        });

                        // Populate dropdown filters
                        courses.forEach(course => {
                            const option = document.createElement('option');
                            option.value = course;
                            option.textContent = course;
                            courseFilter.appendChild(option);
                        });

                        years.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            yearFilter.appendChild(option);
                        });

                        schools.forEach(school => {
                            const option = document.createElement('option');
                            option.value = school;
                            option.textContent = school;
                            schoolFilter.appendChild(option);
                        });
                    } else {
                        console.warn('No users found in the database.');
                    }
                })
                .catch(error => console.error('Failed to fetch user filters:', error.message));
        }


        window.addEventListener('load', () => {
            populateUserFilters(); // Populates course and year filters
            displayUsers(); // Display users with default filters
        });


        function displayUsers() {
            const searchQuery = document.getElementById('searchUserInput').value.toLowerCase();
            const selectedCourse = document.getElementById('userCourseFilter').value;
            const selectedYear = document.getElementById('userYearFilter').value;
            const selectedSchool = document.getElementById('userSchoolFilter').value;
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = ''; // Clear the list before displaying

            // Fetch users from Firebase
            get(child(ref(database), 'users'))
                .then(snapshot => {
                    if (snapshot.exists()) {
                        let found = false;

                        snapshot.forEach(childSnapshot => {
                            const user = childSnapshot.val();
                            const userId = childSnapshot.key;

                            // Check if the user matches the filters
                            const matchesSearch = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase().includes(searchQuery);
                            const matchesCourse = !selectedCourse || user.course === selectedCourse;
                            const matchesYear = !selectedYear || user.year === selectedYear;
                            const matchesSchool = !selectedSchool || user.schoolname === selectedSchool; // Ensure this matches `schooll`

                            if (matchesSearch && matchesCourse && matchesYear && matchesSchool) {
                                found = true;

                                // Create a user list item
                                const listItem = document.createElement('li');
                                listItem.className = 'user-item';
                                listItem.dataset.id = userId;
                                listItem.innerHTML = `
                                    <img src="${user.profileImageUrl || 'default-user.png'}" alt="User Image" class="user-img">
                                    <div class="details">
                                        <strong>${user.firstName || ''} ${user.lastName || ''}</strong><br>
                                        Course: ${user.course || 'N/A'}<br>
                                        Year: ${user.year || 'N/A'}<br>
                                        School: ${user.schoolname || 'N/A'} <!-- Display the correct school -->
                                    </div>
                                `;
                                usersList.appendChild(listItem);
                            }
                        });

                        if (!found) {
                            usersList.innerHTML = '<li>No users match the selected filters.</li>';
                        }
                    } else {
                        usersList.innerHTML = '<li>No users registered.</li>';
                    }
                })
                .catch(error => console.error('Failed to fetch users:', error.message));
        }


        /// Update librarian data
        document.getElementById("updateLibrarian").addEventListener("click", () => {
            if (!currentEditingLibrarianId) {
                alert("Error: No librarian selected for editing.");
                return;
            }

            // Gather updated data
            const updatedData = {
                schoolId: document.getElementById("edit_lib_schoolid").value.trim(), // Updated School ID
                schoolName: document.getElementById("edit_lib_school_select").value, // Selected School Name
                lastName: document.getElementById("edit_lib_lastname").value.trim(),
                firstName: document.getElementById("edit_lib_firstname").value.trim(),
                middleInitial: document.getElementById("edit_lib_middleinitial").value.trim(),
                password: document.getElementById("edit_lib_password").value.trim(),
                contactNum: document.getElementById("edit_lib_contactnum").value.trim(),
                role: document.getElementById("edit_lib_role").value.trim(),
                email: document.getElementById("edit_lib_email").value.trim(),
            };

            // Add status if selected
            const accountStatus = document.getElementById("edit_lib_status").value;
            if (accountStatus) {
                updatedData.accountStatus = accountStatus;
            }

            // Check for updated image
            const librarianImg = document.getElementById("edit_lib_img").files[0];
            if (librarianImg) {
                const storageReference = storageRef(storage, `librarian_images/${currentEditingLibrarianId}`);
                uploadBytes(storageReference, librarianImg)
                    .then(snapshot => getDownloadURL(snapshot.ref))
                    .then(imageUrl => {
                        updatedData.imageUrl = imageUrl; // Update the image URL
                        return updateLibrarianInDatabase(updatedData);
                    })
                    .catch(error => alert("Failed to upload image: " + error.message));
            } else {
                updateLibrarianInDatabase(updatedData);
            }
        });

        // Function to update librarian data in Firebase
        function updateLibrarianInDatabase(data) {
            update(ref(database, `librarians/${currentEditingLibrarianId}`), data)
                .then(() => {
                    alert("Librarian details updated successfully!");
                    sessionStorage.removeItem("editingLibrarianData");
                    navigateToSection("displayLibrarians"); // Redirect to the librarians section
                })
                .catch(error => {
                    console.error("Error updating librarian:", error);
                    alert("Failed to update librarian: " + error.message);
                });
        }

        // Call dropdown population and data loading on page load
        window.addEventListener("load", () => {
            if (location.hash === "#editLibrarian") {
                editPopulateSchoolDropdown();
                loadEditingLibrarianData();
            }
        });
        
        // Disable Account
        function disableAccount(type, id) {
            const updates = {};
            updates[`/${type}/${id}/accountStatus`] = 'disabled';

            set(ref(database), updates)
                .then(() => {
                    alert(`${type.slice(0, -1)} account disabled successfully.`);
                    if (type === 'schools') displaySchools();
                    else if (type === 'librarians') displayLibrarians();
                    else if (type === 'users') displayUsers();
                })
                .catch(error => alert(`Failed to disable ${type.slice(0, -1)} account: ` + error.message));
        }

        // Navigation
        function navigateToSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
            history.pushState(null, '', `#${sectionId}`);
        }

        window.addEventListener('popstate', () => {
            const sectionId = location.hash.substring(1) || 'dashboard';
            navigateToSection(sectionId);
        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', event => {
                event.preventDefault();
                const targetId = event.target.getAttribute('data-target');
                navigateToSection(targetId);

                if (targetId === 'displaySchools') displaySchools();
                else if (targetId === 'displayLibrarians') displayLibrarians();
                else if (targetId === 'displayUsers') displayUsers();
            });
        });

        document.getElementById('librarianSchoolFilter').addEventListener('change', displayLibrarians);
        document.getElementById('librarianRoleFilter').addEventListener('change', displayLibrarians);
        document.getElementById('userCourseFilter').addEventListener('change', displayUsers);
        document.getElementById('userYearFilter').addEventListener('change', displayUsers);
        document.getElementById('userSchoolFilter').addEventListener('change', displayUsers);
        document.getElementById('searchUserInput').addEventListener('input', displayUsers);


        // Load Data on Page Load
        window.addEventListener('load', () => {
            checkAuthentication();
            const sectionId = location.hash.substring(1) || 'dashboard';
            navigateToSection(sectionId);
            updateDashboardChart();
            displaySchools();
            displayLibrarians();
            displayUsers();
        });
    </script>
</body>
</html>
