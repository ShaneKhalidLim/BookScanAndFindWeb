<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard - BookScan&Find</title>
    <link rel="stylesheet" type="text/css" href="app.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="wrapper">
        <div id="navbar">
            <div class="logo">
                <h1>BookScan&Find</h1>
            </div>
            <ul>
                <li><a href="#" class="nav-link" data-target="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link" data-target="addSchool">Add School</a></li>
                <li><a href="#" class="nav-link" data-target="addLibrarian">Add Librarian</a></li>
                <li><a href="#" class="nav-link" data-target="displaySchools">Schools Registered</a></li>
                <li><a href="#" class="nav-link" data-target="displayLibrarians">Librarians Registered</a></li>
                <li><a href="#" class="nav-link" data-target="displayUsers">Users Registered</a></li>
                <li><a href="#" id="logout">Logout</a></li> <!-- Logout -->
            </ul>
        </div>
        <div id="main">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <h2>Dashboard</h2>
                <canvas id="dashboardChart" width="400" height="200"></canvas>
            </div>

            <!-- Add School Section -->
            <div id="addSchool" class="section">
                <h2>Add School</h2>
                <input type="file" id="school_img" class="modern-input">
                <input type="text" id="school_name" placeholder="School Name" class="modern-input">
                <input type="text" id="school_location" placeholder="School Location" class="modern-input">
                <input type="text" id="school_contactnum" placeholder="School Contact Number" class="modern-input">
                <button id="submitSchool" class="modern-button">Add School</button>
            </div>

            <!-- Add Librarian Section -->
            <div id="addLibrarian" class="section">
                <h2>Add Librarian</h2>
                <input type="file" id="lib_img" class="modern-input">
                <input type="text" id="lib_schoolid" placeholder="Librarian School ID" class="modern-input">
                <input type="text" id="lib_lastname" placeholder="Librarian Last Name" class="modern-input">
                <input type="text" id="lib_firstname" placeholder="Librarian First Name" class="modern-input">
                <input type="text" id="lib_middleinitial" placeholder="Librarian Middle Initial (optional)" class="modern-input">
                <input type="password" id="lib_password" placeholder="Password" class="modern-input">
                <input type="text" id="lib_contactnum" placeholder="Librarian Contact Number" class="modern-input">
                <input type="text" id="lib_role" placeholder="Librarian Role" class="modern-input">
                <input type="email" id="lib_email" placeholder="Librarian Email" class="modern-input">
                <button id="submitLibrarian" class="modern-button">Add Librarian</button>
            </div>

            <!-- Display Schools Section -->
            <div id="displaySchools" class="section">
                <h2>Registered Schools</h2>
                <input type="text" id="searchSchoolInput" placeholder="Search Schools" class="modern-search-input">
                <ul id="schoolsList"></ul>
            </div>

            <!-- Display Librarians Section -->
            <div id="displayLibrarians" class="section">
                <h2>Registered Librarians</h2>
                <input type="text" id="searchLibrarianInput" placeholder="Search Librarians" class="modern-search-input">
                <ul id="librariansList"></ul>
            </div>

            <!-- Display Users Section -->
            <div id="displayUsers" class="section">
                <h2>Registered Users</h2>
                <input type="text" id="searchUserInput" placeholder="Search Users" class="modern-search-input">
                <ul id="usersList"></ul>
            </div>

            <!-- Edit School Section -->
            <div id="editSchool" class="section">
                <h2>Edit School</h2>
                <input type="file" id="edit_school_img" class="modern-input">
                <input type="text" id="edit_school_name" placeholder="School Name" class="modern-input">
                <input type="text" id="edit_school_location" placeholder="School Location" class="modern-input">
                <input type="text" id="edit_school_contactnum" placeholder="School Contact Number" class="modern-input">
                <button id="updateSchool" class="modern-button">Update School</button>
            </div>

            <!-- Edit Librarian Section -->
            <div id="editLibrarian" class="section">
                <h2>Edit Librarian</h2>
                <input type="file" id="edit_lib_img" class="modern-input">
                <input type="text" id="edit_lib_schoolid" placeholder="Librarian School ID" class="modern-input">
                <input type="text" id="edit_lib_lastname" placeholder="Librarian Last Name" class="modern-input">
                <input type="text" id="edit_lib_firstname" placeholder="Librarian First Name" class="modern-input">
                <input type="text" id="edit_lib_middleinitial" placeholder="Librarian Middle Initial (optional)" class="modern-input">
                <input type="password" id="edit_lib_password" placeholder="Password" class="modern-input">
                <input type="text" id="edit_lib_contactnum" placeholder="Librarian Contact Number" class="modern-input">
                <input type="text" id="edit_lib_role" placeholder="Librarian Role" class="modern-input">
                <input type="email" id="edit_lib_email" placeholder="Librarian Email" class="modern-input">
                <button id="updateLibrarian" class="modern-button">Update Librarian</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getDatabase, ref, set, get, child, push } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
        import { getAuth, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmTgqh5EXrrtRDJYSY6MvVE5gD7pwJfOE",
            authDomain: "bookscanandfind.firebaseapp.com",
            databaseURL: "https://bookscanandfind-default-rtdb.firebaseio.com",
            projectId: "bookscanandfind",
            storageBucket: "bookscanandfind.appspot.com",
            messagingSenderId: "214479740973",
            appId: "1:214479740973:web:cb437a5a4d9f22cdff18a4",
            measurementId: "G-MFXHQWH2Y3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        
        function checkAuthentication() {
            if (!sessionStorage.getItem('loggedIn')) {
                window.location.replace('index.html');
            }
        }

        // Logout Functionality
        document.getElementById('logout').addEventListener('click', () => {
            signOut(auth).then(() => {
                // Clear session and redirect to sign-in page
                sessionStorage.removeItem('loggedIn');
                window.location.href = 'index.html';
            }).catch(error => {
                alert('Logout failed: ' + error.message);
            });
        });
        
        // Add School
        document.getElementById('submitSchool').addEventListener('click', () => {
            const schoolName = document.getElementById('school_name').value;
            const schoolLocation = document.getElementById('school_location').value;
            const schoolContactNum = document.getElementById('school_contactnum').value;
            const schoolImg = document.getElementById('school_img').files[0];

            if (schoolName && schoolLocation && schoolContactNum && schoolImg) {
                const schoolId = push(ref(database, 'schools')).key;
                const storageReference = storageRef(storage, 'school_images/' + schoolId);
                
                uploadBytes(storageReference, schoolImg)
                    .then(snapshot => getDownloadURL(snapshot.ref))
                    .then(url => set(ref(database, 'schools/' + schoolId), {
                        name: schoolName,
                        location: schoolLocation,
                        contactNum: schoolContactNum,
                        imageUrl: url
                    }))
                    .then(() => {
                        alert('School added successfully');
                        displaySchools();
                        document.getElementById('school_img').value = '';
                        document.getElementById('school_name').value = '';
                        document.getElementById('school_location').value = '';
                        document.getElementById('school_contactnum').value = '';
                    })
                    .catch(error => alert('Failed to add school: ' + error.message));
            } else {
                alert('All fields are required');
            }
        });

        // Add Librarian
        document.getElementById('submitLibrarian').addEventListener('click', () => {
            const libSchoolId = document.getElementById('lib_schoolid').value.trim();
            const libLastName = document.getElementById('lib_lastname').value.trim();
            const libFirstName = document.getElementById('lib_firstname').value.trim();
            const libMiddleInitial = document.getElementById('lib_middleinitial').value.trim();
            const libPassword = document.getElementById('lib_password').value;
            const libContactNum = document.getElementById('lib_contactnum').value.trim();
            const libRole = document.getElementById('lib_role').value.trim();
            const libEmail = document.getElementById('lib_email').value.trim();
            const libImg = document.getElementById('lib_img').files[0];

            if (libSchoolId && libLastName && libFirstName && libPassword && libContactNum && libRole && libEmail && libImg) {
                createUserWithEmailAndPassword(auth, libEmail, libPassword)
                    .then(userCredential => {
                        const libId = userCredential.user.uid;
                        const storageReference = storageRef(storage, 'librarian_images/' + libId);

                        return uploadBytes(storageReference, libImg)
                            .then(snapshot => getDownloadURL(snapshot.ref))
                            .then(url => set(ref(database, 'librarians/' + libId), {
                                schoolId: libSchoolId,
                                lastName: libLastName,
                                firstName: libFirstName,
                                middleInitial: libMiddleInitial,
                                contactNum: libContactNum,
                                role: libRole,
                                email: libEmail,
                                password: libPassword,
                                imageUrl: url
                            }))
                            .then(() => {
                                alert('Librarian added successfully!');
                                document.getElementById('lib_schoolid').value = "";
                                document.getElementById('lib_lastname').value = "";
                                document.getElementById('lib_firstname').value = "";
                                document.getElementById('lib_middleinitial').value = "";
                                document.getElementById('lib_password').value = "";
                                document.getElementById('lib_contactnum').value = "";
                                document.getElementById('lib_role').value = "";
                                document.getElementById('lib_email').value = "";
                                document.getElementById('lib_img').value = "";
                            });
                    })
                    .catch(error => alert("Error creating user. Please try again."));
            } else {
                alert('Please fill out all fields and select an image.');
            }
        });

        // Update Dashboard Chart
        function updateDashboardChart() {
            const labels = ['Schools', 'Librarians', 'users'];
            const data = [0, 0, 0];

            get(child(ref(database), 'schools')).then(snapshot => {
                data[0] = snapshot.exists() ? snapshot.size : 0;
                return get(child(ref(database), 'librarians'));
            }).then(snapshot => {
                data[1] = snapshot.exists() ? snapshot.size : 0;
                return get(child(ref(database), 'users'));
            }).then(snapshot => {
                data[2] = snapshot.exists() ? snapshot.size : 0;

                new Chart(document.getElementById('dashboardChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Counts',
                            data: data,
                            backgroundColor: ['rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)'],
                            borderColor: ['rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }).catch(error => alert('Failed to update chart: ' + error.message));
        }

        // Event listeners for search inputs
        document.getElementById('searchSchoolInput').addEventListener('input', displaySchools);
        document.getElementById('searchLibrarianInput').addEventListener('input', displayLibrarians);
        document.getElementById('searchUserInput').addEventListener('input', displayUsers);

        let currentEditingSchoolId = null;
        let currentEditingLibrarianId = null;
        let currentEditingUserId = null;

        // Display Schools
        function displaySchools() {
            const searchQuery = document.getElementById('searchSchoolInput').value.toLowerCase();
            const schoolsList = document.getElementById('schoolsList');
            schoolsList.innerHTML = '';

            get(child(ref(database), 'schools')).then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const school = childSnapshot.val();
                        const schoolId = childSnapshot.key;
                        if (school.name.toLowerCase().includes(searchQuery) ||
                            school.location.toLowerCase().includes(searchQuery) ||
                            school.contactNum.includes(searchQuery)) {
                            const listItem = document.createElement('li');
                            listItem.className = 'school-item';
                            listItem.dataset.id = schoolId;
                            listItem.innerHTML = `
                                <img src="${school.imageUrl}" alt="School Image">
                                <div class="details">${school.name}<br>${school.location}<br>${school.contactNum}</div>
                                <div class="settings">
                                    <button class="settings-button">&#x22EE;</button>
                                    <div class="settings-menu">
                                        <button class="edit">Edit</button>
                                        <button class="delete">Disable</button>
                                    </div>
                                </div>`;
                            schoolsList.appendChild(listItem);

                            listItem.querySelector('.edit').addEventListener('click', () => {
                                currentEditingSchoolId = schoolId;
                                document.getElementById('edit_school_name').value = school.name;
                                document.getElementById('edit_school_location').value = school.location;
                                document.getElementById('edit_school_contactnum').value = school.contactNum;
                                navigateToSection('editSchool');
                            });

                            listItem.querySelector('.delete').addEventListener('click', () => {
                                disableAccount('schools', schoolId);
                            });
                        }
                    });
                } else {
                    schoolsList.innerHTML = '<li>No schools registered</li>';
                }
            }).catch(error => alert('Failed to retrieve schools: ' + error.message));
        }

        // Display Librarians
    function displayLibrarians() {
    const searchQuery = document.getElementById('searchLibrarianInput').value.toLowerCase();
    const librariansList = document.getElementById('librariansList');
    librariansList.innerHTML = '';

    get(child(ref(database), 'librarians')).then(snapshot => {
        if (snapshot.exists()) {
            const addedLibrarianIds = new Set(); // Create a set to track added librarians
            snapshot.forEach(childSnapshot => {
                const librarian = childSnapshot.val();
                const librarianId = childSnapshot.key;

                if (librarian.firstName.toLowerCase().includes(searchQuery) ||
                    librarian.lastName.toLowerCase().includes(searchQuery) ||
                    librarian.schoolId.toLowerCase().includes(searchQuery) ||
                    librarian.role.toLowerCase().includes(searchQuery)) {

                    if (!addedLibrarianIds.has(librarianId)) { // Only add if not already added
                        const listItem = document.createElement('li');
                        listItem.className = 'librarian-item';
                        listItem.dataset.id = librarianId;
                        listItem.innerHTML = `
                            <img src="${librarian.imageUrl}" alt="Librarian Image">
                            <div class="details">${librarian.schoolId}<br>${librarian.firstName} ${librarian.middleInitial ? librarian.middleInitial + '.' : ''} ${librarian.lastName}<br>${librarian.contactNum}<br>${librarian.role}</div>
                            <div class="settings">
                                <button class="settings-button">&#x22EE;</button>
                                <div class="settings-menu">
                                    <button class="edit">Edit</button>
                                    <button class="delete">Disable</button>
                                </div>
                            </div>`;
                        librariansList.appendChild(listItem);

                        // Add event listeners for edit and delete buttons
                        listItem.querySelector('.edit').addEventListener('click', () => {
                            currentEditingLibrarianId = librarianId;
                            document.getElementById('edit_lib_schoolid').value = librarian.schoolId;
                            document.getElementById('edit_lib_lastname').value = librarian.lastName;
                            document.getElementById('edit_lib_firstname').value = librarian.firstName;
                            document.getElementById('edit_lib_middleinitial').value = librarian.middleInitial || '';
                            document.getElementById('edit_lib_password').value = librarian.password;
                            document.getElementById('edit_lib_contactnum').value = librarian.contactNum;
                            document.getElementById('edit_lib_email').value = librarian.email;
                            document.getElementById('edit_lib_role').value = librarian.role;
                            navigateToSection('editLibrarian');
                        });

                        listItem.querySelector('.delete').addEventListener('click', () => {
                            disableAccount('librarians', librarianId);
                        });

                        addedLibrarianIds.add(librarianId); // Mark as added
                    }
                }
            });
            if (addedLibrarianIds.size === 0) {
                librariansList.innerHTML = '<li>No librarians registered</li>';
            }
        } else {
            librariansList.innerHTML = '<li>No librarians registered</li>';
        }
    }).catch(error => alert('Failed to retrieve librarians: ' + error.message));
}

        // Display Users
        function displayUsers() {
    const searchQuery = document.getElementById('searchUserInput').value.toLowerCase();
    const usersList = document.getElementById('usersList');
    usersList.innerHTML = '';

    get(child(ref(database), 'users')).then(snapshot => {
        if (snapshot.exists()) {
            const addedUserIds = new Set(); // Create a set to track added users
            snapshot.forEach(childSnapshot => {
                const user = childSnapshot.val();
                const userId = childSnapshot.key;

                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                const contactNumber = user.contactNumber || 'No Contact Number';
                const profileImageUrl = user.profileImageUrl || 'default-user.png';

                if (fullName.toLowerCase().includes(searchQuery) || contactNumber.toLowerCase().includes(searchQuery)) {

                    if (!addedUserIds.has(userId)) { // Only add if not already added
                        const listItem = document.createElement('li');
                        listItem.className = 'user-item';
                        listItem.dataset.id = userId;
                        listItem.innerHTML = `
                            <img src="${profileImageUrl}" alt="User Image" class="librarian-img">
                            <div class="details">
                                ${fullName || 'No Name'}<br>
                                ${contactNumber}
                            </div>
                            <div class="settings">
                                <button class="settings-button">&#x22EE;</button>
                                <div class="settings-menu">
                                    <button class="edit">Edit</button>
                                    <button class="delete">Disable</button>
                                </div>
                            </div>`;
                        usersList.appendChild(listItem);

                        // Add event listeners for edit and delete buttons
                        listItem.querySelector('.edit').addEventListener('click', () => {
                            currentEditingUserId = userId;
                            navigateToSection('editUser');
                        });

                        listItem.querySelector('.delete').addEventListener('click', () => {
                            disableAccount('users', userId);
                        });

                        addedUserIds.add(userId); // Mark as added
                    }
                }
            });
            if (addedUserIds.size === 0) {
                usersList.innerHTML = '<li>No users registered</li>';
            }
        } else {
            usersList.innerHTML = '<li>No users registered</li>';
        }
    }).catch(error => alert('Failed to retrieve users: ' + error.message));
}
        // Disable Account
        function disableAccount(type, id) {
            const updates = {};
            updates[`/${type}/${id}/accountStatus`] = 'disabled';

            set(ref(database), updates)
                .then(() => {
                    alert(`${type.slice(0, -1)} account disabled successfully.`);
                    if (type === 'schools') displaySchools();
                    else if (type === 'librarians') displayLibrarians();
                    else if (type === 'users') displayUsers();
                })
                .catch(error => alert(`Failed to disable ${type.slice(0, -1)} account: ` + error.message));
        }

        // Navigation
        function navigateToSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
            history.pushState(null, '', `#${sectionId}`);
        }

        window.addEventListener('popstate', () => {
            const sectionId = location.hash.substring(1) || 'dashboard';
            navigateToSection(sectionId);
        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', event => {
                event.preventDefault();
                const targetId = event.target.getAttribute('data-target');
                navigateToSection(targetId);

                if (targetId === 'displaySchools') displaySchools();
                else if (targetId === 'displayLibrarians') displayLibrarians();
                else if (targetId === 'displayUsers') displayUsers();
            });
        });

        // Load Data on Page Load
        window.addEventListener('load', () => {
            checkAuthentication();
            const sectionId = location.hash.substring(1) || 'dashboard';
            navigateToSection(sectionId);
            updateDashboardChart();
            displaySchools();
            displayLibrarians();
            displayUsers();
        });
    </script>
</body>
</html>
